<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理器</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .file-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            height: 100%;
            background: white;
        }

        .file-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .file-icon {
            font-size: 48px;
            text-align: center;
            padding: 20px 0;
            color: #6c757d;
        }

        .file-info {
            padding: 15px;
        }

        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.8em;
            color: #6c757d;
        }

        .file-actions {
            padding: 0 15px 15px;
            display: flex;
            justify-content: space-between;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: border-color 0.3s;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #667eea;
        }

        .nav-buttons {
            margin-bottom: 20px;
        }

        .file-grid {
            margin-bottom: 20px;
        }

        .no-files {
            text-align: center;
            color: #6c757d;
            padding: 40px;
        }
        
        /* 上传进度条样式 */
        .upload-progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            display: none;
        }

        .upload-progress-bar {
            width: 0%;
            height: 5px;
            background-color: #28a745;
            transition: width 0.3s;
        }

        .upload-progress-text {
            position: fixed;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            min-width: 200px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- 上传进度条 -->
    <div class="upload-progress-container" id="uploadProgressContainer">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
        <div class="upload-progress-text" id="uploadProgressText">上传进度: 0%</div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="bi bi-files"></i> 文件管理器</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="uploadBtn">
                            <i class="bi bi-upload"></i> 上传文件
                        </button>
                        <button class="btn btn-outline-secondary" id="refreshBtn">
                            <i class="bi bi-arrow-repeat"></i> 刷新
                        </button>
                        <button class="btn btn-outline-danger" id="logoutBtn">
                            <i class="bi bi-box-arrow-right"></i> 退出登录
                        </button>
                    </div>
                </div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb" id="breadcrumb">
                        <li class="breadcrumb-item"><a href="#" onclick="goToRoot(); return false;"
                                data-path="/">根目录</a></li>
                    </ol>
                </nav>

                <div class="row file-grid" id="fileGrid">
                </div>

                <div class="no-files d-none" id="noFilesMessage">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mt-2">此目录中没有文件</p>
                </div>
            </div>
        </div>
        <input type="file" id="fileInput" style="display: none;" multiple>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        // 获取token
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // 从URL参数中获取root和path
        const urlParams = new URLSearchParams(window.location.search);
        let currentRoot = urlParams.get('root') || '';
        let currentPath = urlParams.get('path') || '';

        // 用于跟踪上传进度的变量
        let uploadStartTime = 0;
        let uploadTotal = 0;
        let uploadLoaded = 0;

        // 初始化页面
        $(document).ready(function () {
            loadFiles();
            setupEventListeners();
            updateBreadcrumb();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 上传按钮点击事件
            $('#uploadBtn').click(function () {
                $('#fileInput').click();
            });

            // 文件选择事件
            $('#fileInput').change(function (e) {
                const files = e.target.files;
                console.log(files);
                handleFileUpload(files);
            });

            // 刷新按钮
            $('#refreshBtn').click(function () {
                loadFiles(currentPath);
            });

            // 退出登录
            $('#logoutBtn').click(function () {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            });
        }

        // 加载文件列表
        function loadFiles() {
            const encodedRoot = encodeURIComponent(currentRoot);
            const encodedPath = encodeURIComponent(currentPath);
            const url = `/api/files?root=${encodedRoot}&path=${encodedPath}`;

            $.ajax({
                url: url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function (response) {
                    displayFiles(response.files);
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 401) {
                        // 认证失败，重定向到登录页面
                        alert('登录已过期，请重新登录');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    console.error('加载文件失败:', error);
                    alert('加载文件失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        }

        // 显示文件列表
        function displayFiles(files) {
            const fileGrid = $('#fileGrid');
            fileGrid.empty();

            if (files.length === 0) {
                $('#noFilesMessage').removeClass('d-none');
                return;
            }

            $('#noFilesMessage').addClass('d-none');

            files.forEach(function (file) {
                const card = createFileCard(file);
                fileGrid.append(card);
            });

        }

        // 创建文件卡片
        function createFileCard(file) {
            const isDirectory = file.is_dir; // 使用is_dir而不是type
            const iconClass = isDirectory ? 'bi-folder' : getFileIcon(file.name);
            const size = isDirectory ? '(文件夹)' : `(文件-${formatFileSize(file.size)})`;

            let root = '';
            let path = '';
            if (currentRoot && currentRoot.length > 0) {
                root = currentRoot
                path = currentPath + file.name + '/';
            } else {
                root = file.name
            }

            const card = `
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="file-card" ${isDirectory ? 'data-is-dir="true"' : 'data-is-dir="false"'} data-path="${file.name}">
                        <div class="file-icon">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name" title="${file.name}">${truncateText(file.name, 20)}</div>
                            <div class="file-size">${size}</div>
                        </div>
                        <div class="file-actions">
                            ${isDirectory ?
                    `<button class="btn btn-sm btn-outline-primary" onclick="goToPath('${root}', '${path}')">
                                    <i class="bi bi-folder"></i> 打开
                                </button>` :
                    `<button class="btn btn-sm btn-outline-success" onclick="downloadFile('${file.name}')">
                                    <i class="bi bi-download"></i> 下载
                                </button>`
                }
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // 根据文件扩展名返回图标
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const videoExts = ['mp4', 'avi', 'mov', 'mkv', 'wmv'];
            const audioExts = ['mp3', 'wav', 'flac', 'aac', 'ogg'];
            const docExts = ['pdf', 'doc', 'docx', 'txt', 'xls', 'xlsx', 'ppt', 'pptx'];

            if (imageExts.includes(ext)) return 'bi-image';
            if (videoExts.includes(ext)) return 'bi-film';
            if (audioExts.includes(ext)) return 'bi-music-note';
            if (docExts.includes(ext)) return 'bi-file-earmark-text';
            return 'bi-file-earmark';
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 截断文本
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }


        // 下载文件
        function downloadFile(name) {
            const filePath = currentPath + name;
            const url = `/api/download?root=${currentRoot}&path=${encodeURIComponent(filePath)}&token=${token}`;

            // 创建一个隐藏的iframe来处理下载，这样浏览器会显示下载进度
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            iframe.id = 'download-iframe';

            // 监听错误
            iframe.onload = function () {
                // 尝试获取iframe内容（如果失败会抛出错误）
                try {
                    const content = iframe.contentDocument || iframe.contentWindow.document;
                    if (content && content.title && content.title.includes('401')) {
                        handleAuthError();
                    }
                } catch (e) {
                    // 捕获跨域错误等
                    // 我们不能直接检查响应状态，所以依赖fetch方法
                }
            };

            iframe.onerror = function () {
                handleAuthError();
            };

            document.body.appendChild(iframe);

            // 替代方案：使用fetch来检查认证状态
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (response.status === 401) {
                        handleAuthError();
                    } else if (!response.ok) {
                        console.error('下载失败:', response.status);
                    }
                })
                .catch(error => {
                    console.error('下载请求错误:', error);
                });
        }

        // 处理认证错误的通用函数
        function handleAuthError() {
            alert('登录已过期，请重新登录');
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // 更新面包屑导航
        function updateBreadcrumb() {
            const breadcrumb = $('#breadcrumb');
            breadcrumb.empty();

            // 添加根目录
            breadcrumb.append('<li class="breadcrumb-item"><a href="#" onclick="goToRoot(); return false;" data-path="/">根目录</a></li>');

            // 添加路径层级
            if (currentRoot && currentRoot !== '') {
                // 添加根目录
                breadcrumb.append(`<li class="breadcrumb-item"><a href="#" onclick="goToPath('${currentRoot}', ''); return false;" data-path="/">${currentRoot}</a></li>`);

                if (currentPath && currentPath !== '') {
                    const pathParts = currentPath.split('/');
                    let parts = '';
                    pathParts.forEach(function (part, index) {
                        parts += part + '/';
                        if (index === pathParts.length - 1) {
                            breadcrumb.append(`<li class="breadcrumb-item active">${part}</li>`);
                        } else {
                            breadcrumb.append(`<li class="breadcrumb-item"><a href="#" onclick="goToPath('${currentRoot}', '${parts}'); return false;" data-path="${parts}">${part}</a></li>`);
                        }
                    });
                }
            }
        }

        // 跳转到根目录
        function goToRoot() {
            goToPath('', '');
        }

        // 跳转到指定路径
        function goToPath(root, path) {
            currentRoot = root;
            currentPath = path;

            // 构建新的查询参数字符串
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('root', root);
            urlParams.set('path', path);

            // 更新URL，但不刷新页面
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.pushState({}, '', newUrl);

            console.log('currentRoot:', currentRoot);
            console.log('currentPath:', currentPath);
            loadFiles();
            updateBreadcrumb();
        }

        // 处理文件上传
        function handleFileUpload(files) {
            if (!currentRoot || currentRoot === '') {
                alert('不能上传文件到根目录');
                return;
            }
            for (let i = 0; i < files.length; i++) {
                uploadFile(files[i]);
            }
        }

        // 上传单个文件
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('root', currentRoot);
            formData.append('path', currentPath);
            formData.append('file', file);

            // 显示上传进度条
            showUploadProgress();

            $.ajax({
                url: '/api/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                xhr: function () {
                    const xhr = new window.XMLHttpRequest();
                    
                    // 上传进度
                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            uploadTotal = evt.total;
                            uploadLoaded = evt.loaded;
                            
                            // 计算上传速度
                            const currentTime = new Date().getTime();
                            const timeElapsed = (currentTime - uploadStartTime) / 1000; // 秒
                            
                            // 更新进度条
                            const percentComplete = evt.loaded / evt.total * 100;
                            updateUploadProgress(percentComplete, evt.loaded, evt.total);
                            
                            // 计算上传速度（如果时间大于0.5秒，避免频繁更新）
                            if (timeElapsed > 0.5) {
                                const speed = evt.loaded / timeElapsed; // bytes per second
                                updateUploadSpeed(speed);
                            }
                        }
                    }, false);
                    
                    // 记录开始时间
                    xhr.upload.addEventListener("loadstart", function() {
                        uploadStartTime = new Date().getTime();
                        uploadTotal = 0;
                        uploadLoaded = 0;
                    }, false);
                    
                    return xhr;
                },
                success: function (response) {
                    console.log('文件上传成功:', file.name);
                    hideUploadProgress();
                    loadFiles();
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 401) {
                        // 认证失败，重定向到登录页面
                        alert('登录已过期，请重新登录');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    console.error('文件上传失败:', error);
                    hideUploadProgress();
                    alert('文件上传失败: ' + (xhr.responseJSON?.message || '未知错误'));
                }
            });
        }

        // 显示上传进度条
        function showUploadProgress() {
            document.getElementById('uploadProgressContainer').style.display = 'block';
            updateUploadProgress(0, 0, 0);
        }

        // 更新上传进度
        function updateUploadProgress(percent, loaded, total) {
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            
            // 更新进度条宽度
            progressBar.style.width = percent + '%';
            
            // 更新进度文本
            const loadedMB = (loaded / (1024 * 1024)).toFixed(2);
            const totalMB = (total / (1024 * 1024)).toFixed(2);
            progressText.textContent = `上传进度: ${Math.round(percent)}% (${loadedMB}MB / ${totalMB}MB)`;
        }

        // 更新上传速度
        function updateUploadSpeed(bytesPerSecond) {
            const progressText = document.getElementById('uploadProgressText');
            const speedKB = (bytesPerSecond / 1024).toFixed(2);
            const speedMB = (bytesPerSecond / (1024 * 1024)).toFixed(2);
            
            // 获取当前进度信息
            const percent = (uploadLoaded / uploadTotal) * 100;
            const loadedMB = (uploadLoaded / (1024 * 1024)).toFixed(2);
            const totalMB = (uploadTotal / (1024 * 1024)).toFixed(2);
            
            if (bytesPerSecond >= 1024 * 1024) {
                progressText.textContent = `上传进度: ${Math.round(percent)}% (${loadedMB}MB / ${totalMB}MB) - 速度: ${speedMB} MB/s`;
            } else {
                progressText.textContent = `上传进度: ${Math.round(percent)}% (${loadedMB}MB / ${totalMB}MB) - 速度: ${speedKB} KB/s`;
            }
        }

        // 隐藏上传进度条
        function hideUploadProgress() {
            document.getElementById('uploadProgressContainer').style.display = 'none';
        }

        // 全局函数供HTML使用
        window.downloadFile = downloadFile;
        window.goToRoot = goToRoot;
        window.goToPath = goToPath;
    </script>
</body>

</html>